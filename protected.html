<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>🔒 メンバーページ</title>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/1.19/auth0-spa-js.production.js"></script>
</head>
<body>
  <h1>🔒 メンバーページ</h1>
  <div id="content" style="display: none;">
    <p id="user-info"></p>
    <p id="graph-info"></p>
    <button onclick="logout()">ログアウト</button>
  </div>

  <script type="module">
    const auth0 = await createAuth0Client({
      domain: "YOUR_AUTH0_DOMAIN", // 例: your-tenant.auth0.com
      client_id: "YOUR_CLIENT_ID", // Auth0のアプリケーションのクライアントID
      redirect_uri: window.location.origin + "/protected.html",
      audience: "https://graph.microsoft.com", // ここが重要！
      scope: "openid profile email User.Read Directory.Read.All"
    });

    // リダイレクトから戻ったときの処理
    if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
      await auth0.handleRedirectCallback();
      window.history.replaceState({}, document.title, "/protected.html");
    }

    const isAuthenticated = await auth0.isAuthenticated();
    if (!isAuthenticated) {
      await auth0.loginWithRedirect();
    } else {
      // 認証済みならユーザー情報表示
      const user = await auth0.getUser();
      document.getElementById("user-info").textContent = `✅ ${user.name || user.email} としてログイン中です`;

      // Microsoft Graph API用のアクセストークンを取得
      try {
        const token = await auth0.getTokenSilently({
          audience: "https://graph.microsoft.com",
          scope: "User.Read Directory.Read.All"
        });

        // Microsoft Graph APIで所属グループ（≒ロール）を取得
        const response = await fetch("https://graph.microsoft.com/v1.0/me/memberOf", {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });

        if (!response.ok) throw new Error("Graph APIリクエスト失敗");

        const graphData = await response.json();

        const groups = graphData.value.map(group => group.displayName).join(", ");
        document.getElementById("graph-info").textContent = `🔑 所属グループ/ロール: ${groups || "なし"}`;
      } catch (e) {
        console.error("Graph APIエラー:", e);
        document.getElementById("graph-info").textContent = "❌ 権限情報の取得に失敗しました";
      }

      document.getElementById("content").style.display = "block";
    }

    window.logout = () => {
      auth0.logout({ returnTo: window.location.origin });
    };
  </script>
</body>
</html>
